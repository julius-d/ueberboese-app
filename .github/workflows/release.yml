name: Android Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  version:
    name: Calculate Semantic Version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.semver.outputs.new_tag }}
      previous_version: ${{ steps.semver.outputs.tag }}
      changelog: ${{ steps.semver.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate semantic version
        id: semver
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dry_run: true
          default_bump: minor
          default_prerelease_bump: prerelease
          release_branches: main
          pre_release_branches: develop
          fetch_all_tags: true
          tag_prefix: ''

      - name: Display version info
        run: |
          echo "Previous version: ${{ steps.semver.outputs.tag }}"
          echo "New version: ${{ steps.semver.outputs.new_tag }}"
          echo "Version bump: ${{ steps.semver.outputs.part }}"

  build:
    name: Build Signed APK
    needs: version
    runs-on: ubuntu-latest
    if: needs.version.outputs.new_version != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display build info
        run: |
          echo "========================================="
          echo "Build Information"
          echo "========================================="
          echo "Git commit: $(git rev-parse HEAD)"
          echo "Git commit (short): $(git rev-parse --short HEAD)"
          echo "Git branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Last commit message: $(git log -1 --pretty=%B)"
          echo "Last commit author: $(git log -1 --pretty=format:'%an <%ae>')"
          echo "Last commit date: $(git log -1 --pretty=format:'%cd')"
          echo "Target version: ${{ needs.version.outputs.new_version }}"
          echo "========================================="

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate mock files
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Update version in pubspec.yaml
        run: |
          VERSION="${{ needs.version.outputs.new_version }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
          echo "Updated pubspec.yaml to version $VERSION"
          cat pubspec.yaml | grep "^version:"

      - name: Decode keystore
        run: |
          echo "========================================="
          echo "Decoding keystore from base64..."
          echo "========================================="

          # Check if secret is set
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "ERROR: ANDROID_KEYSTORE_BASE64 secret is not set!"
            exit 1
          fi

          echo "ANDROID_KEYSTORE_BASE64 secret is set âœ“"

          # Decode the keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/upload-keystore.jks

          # Verify the file was created
          if [ ! -f android/upload-keystore.jks ]; then
            echo "ERROR: Keystore file was not created!"
            exit 1
          fi

          # Check file details
          echo "Keystore file created successfully:"
          ls -lh android/upload-keystore.jks
          FILE_SIZE=$(stat -c%s android/upload-keystore.jks 2>/dev/null || stat -f%z android/upload-keystore.jks)
          echo "File size: $FILE_SIZE bytes"

          # Keystore files should be at least 1KB
          if [ "$FILE_SIZE" -lt 1000 ]; then
            echo "WARNING: Keystore file seems too small ($FILE_SIZE bytes). It might be corrupted!"
          fi

          echo "File type: $(file android/upload-keystore.jks)"
          echo "MD5 checksum: $(md5sum android/upload-keystore.jks 2>/dev/null || md5 android/upload-keystore.jks)"

      - name: Create key.properties
        run: |
          echo "========================================="
          echo "Creating key.properties..."
          echo "========================================="

          # Check if all required secrets are set
          if [ -z "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ]; then
            echo "ERROR: ANDROID_KEYSTORE_PASSWORD secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ]; then
            echo "ERROR: ANDROID_KEY_PASSWORD secret is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.ANDROID_KEY_ALIAS }}" ]; then
            echo "ERROR: ANDROID_KEY_ALIAS secret is not set!"
            exit 1
          fi

          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF
          echo "key.properties created successfully"
          echo ""
          echo "Configuration (passwords masked):"
          sed 's/Password=.*/Password=***MASKED***/g' android/key.properties

      - name: Verify keystore
        env:
          STORE_PASS: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASS: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          echo "========================================="
          echo "Verifying keystore integrity..."
          echo "========================================="

          # Test 1: Verify we can open the keystore with the password
          echo "Test 1: Opening keystore with password..."
          if ! keytool -list -keystore android/upload-keystore.jks \
            -storepass:env STORE_PASS > /tmp/keystore_list.txt 2>&1; then
            echo "âŒ FAILED: Cannot open keystore with the provided password!"
            echo ""
            echo "Possible causes:"
            echo "1. ANDROID_KEYSTORE_PASSWORD is incorrect"
            echo "2. Keystore file is corrupted (check base64 encoding)"
            echo "3. Base64 secret contains line breaks or extra characters"
            echo ""
            echo "To fix:"
            echo "- Verify your keystore password is correct"
            echo "- Re-encode your keystore: base64 -w 0 your-keystore.jks (Linux) or base64 -i your-keystore.jks (macOS)"
            echo "- Make sure to copy the entire base64 output as a single line"
            echo ""
            echo "Note: Error details hidden to protect secrets"
            exit 1
          fi
          echo "âœ… SUCCESS: Keystore opened successfully!"
          echo ""

          # Show keystore contents (safe - no secrets in this output)
          echo "Keystore contents:"
          cat /tmp/keystore_list.txt
          echo ""

          # Test 2: Verify the alias exists
          echo "Test 2: Checking if alias exists..."
          if ! keytool -list -keystore android/upload-keystore.jks \
            -storepass:env STORE_PASS \
            -alias "$KEY_ALIAS" > /tmp/alias_check.txt 2>&1; then
            echo "âŒ FAILED: Configured alias not found in keystore!"
            echo ""
            echo "Available aliases in keystore:"
            grep "Alias name:" /tmp/keystore_list.txt || echo "(Could not parse aliases)"
            echo ""
            echo "To fix: Update ANDROID_KEY_ALIAS secret to match one of the aliases above"
            exit 1
          fi
          echo "âœ… SUCCESS: Alias found in keystore!"
          echo ""

          # Test 3: Verify we can access the key with the key password
          echo "Test 3: Verifying key password..."
          if ! keytool -list -keystore android/upload-keystore.jks \
            -storepass:env STORE_PASS \
            -alias "$KEY_ALIAS" \
            -keypass:env KEY_PASS > /tmp/key_check.txt 2>&1; then
            echo "âŒ FAILED: Cannot access key with the provided key password!"
            echo ""
            echo "To fix: Verify ANDROID_KEY_PASSWORD is correct"
            echo ""
            echo "Note: Error details hidden to protect secrets"
            exit 1
          fi
          echo "âœ… SUCCESS: Key password is correct!"
          echo ""
          echo "========================================="
          echo "âœ… All keystore verification tests passed!"
          echo "========================================="

      - name: Build APK
        run: flutter build apk --release

      - name: Rename APK
        run: |
          VERSION="${{ needs.version.outputs.new_version }}"
          VERSION="${VERSION#v}"
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/ueberboese-app-$VERSION.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/ueberboese-app-*.apk
          retention-days: 90

  release:
    name: Create GitHub Release
    needs: [version, build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: ./artifacts

      - name: Create Release Tag
        id: create_tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: ${{ needs.version.outputs.new_version }}
          tag_prefix: ''

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.version.outputs.new_version }}"
          PREV_VERSION="${{ needs.version.outputs.previous_version }}"

          # If no previous version, get all commits
          if [ -z "$PREV_VERSION" ] || [ "$PREV_VERSION" == "null" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log ${PREV_VERSION}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Create changelog
          CHANGELOG="## What's Changed

          $COMMITS

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_VERSION}...${VERSION}"

          # Save to file and environment
          echo "$CHANGELOG" > changelog.md
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version.outputs.new_version }}
          name: Release ${{ needs.version.outputs.new_version }}
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: false
          files: ./artifacts/ueberboese-app-*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "âœ… Release ${{ needs.version.outputs.new_version }} created successfully!"
          echo "ðŸ“¦ APK uploaded to: https://github.com/${{ github.repository }}/releases/tag/${{ needs.version.outputs.new_version }}"
